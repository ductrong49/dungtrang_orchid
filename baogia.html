<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Web tạo ảnh báo giá (không lưu server)</title>
<style>
  :root{
    --bg:#f3f4f6;
    --card:#ffffff;
    --accent:#0b74da;
    --muted:#6b7280;
  }
  body{font-family:Inter, system-ui, Arial, Helvetica, sans-serif; background:var(--bg); margin:0; padding:24px; color:#111}
  .wrap{max-width:980px; margin:0 auto; display:grid; gap:18px; grid-template-columns:1fr 420px;}
  header{grid-column:1/-1; display:flex; gap:12px; align-items:center;}
  h1{margin:0; font-size:20px;}
  p.lead{margin:0; color:var(--muted); font-size:13px}
  .card{background:var(--card); border-radius:10px; padding:14px; box-shadow:0 6px 18px rgba(12,12,12,0.06);}
  form .row{display:flex; gap:8px; margin-bottom:10px;}
  label{font-size:13px; color:var(--muted); display:block; margin-bottom:6px}
  input[type="text"], input[type="file"], input[type="number"], input[type="tel"], input[type="date"], select, textarea {
    width:100%; padding:8px 10px; border-radius:8px; border:1px solid #e5e7eb; font-size:14px; box-sizing:border-box;
  }
  .small{font-size:13px; color:var(--muted);}
  button{background:var(--accent); color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer;}
  button.secondary{background:#374151;}
  canvas{width:100%; height:auto; border-radius:8px; background:#fff; display:block;}
  .controls{display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;}
  .right-col{display:flex; flex-direction:column; gap:12px;}
  .preview-wrap{display:flex; flex-direction:column; gap:8px;}
  .info-inline{display:flex; gap:8px;}
  .muted{color:var(--muted)}
  @media (max-width:980px){
    .wrap{grid-template-columns:1fr; padding-bottom:60px;}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Trình tạo ảnh báo giá (client-side)</h1>
      <p class="lead">Upload ảnh, nhập thông tin — tạo ảnh có ghi thông tin & tải về. Không lưu trữ trên server.</p>
    </div>
  </header>

  <!-- LEFT: canvas preview và các tuỳ chọn xuất -->
  <div class="card">
    <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;">
      <div><strong>Preview ảnh</strong><div class="small muted">Xem trước & điều chỉnh</div></div>
      <div class="info-inline">
        <label class="small muted" style="align-self:center;margin:0 6px 0 0">Định dạng</label>
        <select id="exportFormat" title="Chọn định dạng">
          <option value="image/png">PNG (khuyến nghị)</option>
          <option value="image/jpeg">JPEG</option>
        </select>
      </div>
    </div>

    <div style="margin-top:12px;">
      <canvas id="canvas"></canvas>
      <div class="controls">
        <button id="downloadBtn">Tải ảnh xuống</button>
        <button id="downloadJpeg" class="secondary">Tải JPEG (quality 0.9)</button>
        <button id="resetBtn" class="secondary">Xoá & bắt đầu lại</button>
        <label class="small muted" style="align-self:center;margin-left:12px">Lưu ý: ảnh xử lý ở trình duyệt (không upload lên server)</label>
      </div>
    </div>
  </div>

  <!-- RIGHT: form nhập thông tin -->
  <aside class="right-col">
    <div class="card">
      <h3 style="margin:0 0 8px 0">Upload & thông tin ảnh</h3>
      <form id="dataForm" onsubmit="return false;">
        <div>
          <label for="imageInput">Chọn ảnh sản phẩm</label>
          <input id="imageInput" type="file" accept="image/*" />
          <div class="small muted">Ảnh sẽ được vẽ lên canvas (jpg/png/heic tuỳ trình duyệt).</div>
        </div>

        <div style="margin-top:10px;">
          <label for="productName">Tên sản phẩm</label>
          <input id="productName" type="text" placeholder="Ví dụ: Bình giữ nhiệt 500ml" />
        </div>

        <div class="row" style="margin-top:10px">
          <div style="flex:1">
            <label for="size">Kích thước</label>
            <input id="size" type="text" placeholder="Ví dụ: 500ml / M / 40x30cm" />
          </div>
          <div style="width:130px">
            <label for="qty">Số lượng</label>
            <input id="qty" type="number" min="0" value="1" />
          </div>
        </div>

        <div style="margin-top:8px;">
          <label for="price">Giá (số nguyên)</label>
          <input id="price" type="number" min="0" step="1" placeholder="Ví dụ: 199000" />
          <div class="small muted">Sẽ hiển thị định dạng tiền khi vẽ lên ảnh (VNĐ).</div>
        </div>

        <div style="margin-top:8px;">
          <label for="phone">Số điện thoại</label>
          <input id="phone" type="tel" placeholder="Ví dụ: 0912345678" />
        </div>

        <div class="row" style="margin-top:8px">
          <div style="flex:1">
            <label for="quoteDate">Ngày báo giá</label>
            <input id="quoteDate" type="date" />
          </div>
          <div style="width:120px">
            <label for="fontSize">Kích chữ</label>
            <input id="fontSize" type="number" min="12" max="72" value="22" />
          </div>
        </div>

        <div style="margin-top:8px;">
          <label for="overlayPosition">Vị trí thông tin trên ảnh</label>
          <select id="overlayPosition">
            <option value="bottom">Dưới cùng (mặc định)</option>
            <option value="top">Trên cùng</option>
            <option value="center">Giữa ảnh</option>
          </select>
        </div>

        <div style="margin-top:10px; display:flex; gap:8px;">
          <button id="renderBtn">Tạo ảnh (gắn thông tin)</button>
          <button id="downloadImmediate" class="secondary" type="button">Tạo & Tải nhanh</button>
        </div>
      </form>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0">Tuỳ chọn hiển thị</h3>
      <div style="display:flex; gap:8px; align-items:center;">
        <label style="margin:0">Màu chữ</label>
        <input id="textColor" type="color" value="#ffffff" />
        <label style="margin:0">Màu nền khung</label>
        <input id="boxColor" type="color" value="#000000" />
      </div>
      <div style="margin-top:8px;">
        <label class="small">Độ mờ khung (0-1)</label>
        <input id="boxOpacity" type="number" min="0" max="1" step="0.05" value="0.6" />
      </div>
      <div style="margin-top:8px;">
        <label class="small">Độ bo góc khung (px)</label>
        <input id="boxRadius" type="number" min="0" max="60" value="12" />
      </div>
    </div>

    <div class="card small muted">
      <strong>Hướng dẫn nhanh:</strong>
      <ul style="margin:8px 0 0 18px; padding:0;">
        <li>Chọn ảnh → nhập thông tin → nhấn "Tạo ảnh".</li>
        <li>Nhấn "Tải ảnh xuống" để lưu file PNG/JPEG.</li>
        <li>Không có dữ liệu nào được gửi ra server — mọi thứ xử lý ở trình duyệt.</li>
      </ul>
    </div>
  </aside>

</div>

<script>
/*
  Script hoạt động:
  - Load ảnh từ input file, vẽ ảnh gốc lên canvas với kích thước thực (giới hạn max size nếu cần).
  - Khi nhấn "Tạo ảnh", vẽ khung mờ và text (tên, kích thước, qty, giá, phone, date).
  - Cho phép tải xuống (PNG/JPEG).
  - Không upload server.
*/

const imageInput = document.getElementById('imageInput');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d', { willReadFrequently: false });
let img = new Image();
let imgLoaded = false;
const MAX_WIDTH = 2000; // giới hạn kích thước để tránh ảnh quá lớn khiến trình duyệt chậm
const MAX_HEIGHT = 2000;

const productName = document.getElementById('productName');
const sizeInput = document.getElementById('size');
const qtyInput = document.getElementById('qty');
const priceInput = document.getElementById('price');
const phoneInput = document.getElementById('phone');
const quoteDate = document.getElementById('quoteDate');
const fontSizeInput = document.getElementById('fontSize');
const overlayPosition = document.getElementById('overlayPosition');
const textColor = document.getElementById('textColor');
const boxColor = document.getElementById('boxColor');
const boxOpacity = document.getElementById('boxOpacity');
const boxRadius = document.getElementById('boxRadius');

const renderBtn = document.getElementById('renderBtn');
const downloadBtn = document.getElementById('downloadBtn');
const downloadJpeg = document.getElementById('downloadJpeg');
const downloadImmediate = document.getElementById('downloadImmediate');
const resetBtn = document.getElementById('resetBtn');
const exportFormat = document.getElementById('exportFormat');

// Set default date to today (local)
(function setToday(){
  const today = new Date();
  const y = today.getFullYear();
  const m = String(today.getMonth()+1).padStart(2,'0');
  const d = String(today.getDate()).padStart(2,'0');
  quoteDate.value = `${y}-${m}-${d}`;
})();

// Read file and load image
imageInput.addEventListener('change', (e)=>{
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    img = new Image();
    img.onload = function(){
      imgLoaded = true;
      // resize canvas to image size, but constrain to MAX
      let w = img.width;
      let h = img.height;
      const ratio = w/h;
      if(w > MAX_WIDTH){ w = MAX_WIDTH; h = Math.round(w/ratio); }
      if(h > MAX_HEIGHT){ h = MAX_HEIGHT; w = Math.round(h*ratio); }
      canvas.width = w;
      canvas.height = h;
      // draw original image
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
});

// helper: format price as "199.000 đ" (dot thousands)
function formatPrice(num){
  if(!num && num !== 0) return '';
  // ensure number
  const n = Number(num);
  if(Number.isNaN(n)) return num;
  return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + " đ";
}

// helper: draw rounded rect
CanvasRenderingContext2D.prototype.roundRect = function(x, y, w, h, r) {
  if (w < 2 * r) r = w / 2;
  if (h < 2 * r) r = h / 2;
  this.beginPath();
  this.moveTo(x + r, y);
  this.arcTo(x + w, y, x + w, y + h, r);
  this.arcTo(x + w, y + h, x, y + h, r);
  this.arcTo(x, y + h, x, y, r);
  this.arcTo(x, y, x + w, y, r);
  this.closePath();
  return this;
}

// main draw function: draws base image then overlay box & text
function drawOverlay(){
  if(!imgLoaded) {
    alert('Chưa có ảnh để xử lý. Vui lòng chọn ảnh trước.');
    return;
  }
  // first draw original image
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

  // gather info
  const name = productName.value.trim();
  const size = sizeInput.value.trim();
  const qty = qtyInput.value || '';
  const price = priceInput.value || '';
  const phone = phoneInput.value.trim();
  const date = quoteDate.value;
  const fontSz = Math.max(12, Number(fontSizeInput.value) || 22);
  const pos = overlayPosition.value;
  const txtColor = textColor.value || '#ffffff';
  const bColor = boxColor.value || '#000000';
  const opacity = Math.min(1, Math.max(0, parseFloat(boxOpacity.value || 0.6)));
  const radius = Number(boxRadius.value) || 12;

  // prepare lines to render
  const lines = [];
  if(name) lines.push(name);
  let line2 = [];
  if(size) line2.push(size);
  if(qty !== '') line2.push('SL: ' + qty);
  if(line2.length) lines.push(line2.join(' • '));
  if(price) lines.push('Giá: ' + formatPrice(price));
  if(phone) lines.push('ĐT: ' + phone);
  if(date) {
    // format date to dd/mm/yyyy
    const parts = date.split('-');
    if(parts.length === 3) lines.push('Ngày: ' + parts[2] + '/' + parts[1] + '/' + parts[0]);
    else lines.push('Ngày: ' + date);
  }

  if(lines.length === 0){
    // nothing to draw
    return;
  }

  // choose width of box: nearly full width with padding
  const padding = Math.round(fontSz * 0.6);
  const maxBoxWidth = canvas.width - 40;
  // measure text width
  ctx.font = `${fontSz}px sans-serif`;
  let maxTextWidth = 0;
  lines.forEach(l=>{
    const m = ctx.measureText(l);
    const w = m.width;
    if(w > maxTextWidth) maxTextWidth = w;
  });
  const boxW = Math.min(maxBoxWidth, Math.round(maxTextWidth) + padding * 2);
  const lineHeight = Math.round(fontSz * 1.25);
  const boxH = lines.length * lineHeight + padding * 2;

  // compute box position
  let boxX = 20;
  let boxY = 20;
  if(pos === 'bottom'){
    boxX = 20;
    boxY = canvas.height - boxH - 20;
  } else if(pos === 'center'){
    boxX = Math.round((canvas.width - boxW)/2);
    boxY = Math.round((canvas.height - boxH)/2);
  } // top already default

  // draw rounded semi-transparent box
  ctx.save();
  ctx.globalAlpha = opacity;
  ctx.fillStyle = bColor;
  ctx.roundRect(boxX, boxY, boxW, boxH, radius);
  ctx.fill();
  ctx.restore();

  // draw text lines
  ctx.fillStyle = txtColor;
  ctx.textBaseline = 'top';
  ctx.font = `bold ${fontSz}px sans-serif`;
  let ty = boxY + padding;
  for(let i=0;i<lines.length;i++){
    const line = lines[i];
    // use bold for first line, normal for others
    if(i === 0) ctx.font = `bold ${Math.round(fontSz+2)}px sans-serif`;
    else ctx.font = `${fontSz}px sans-serif`;
    // clip text if too long: wrap simple
    const measured = ctx.measureText(line).width;
    if(measured <= boxW - padding*2){
      ctx.fillText(line, boxX + padding, ty);
      ty += lineHeight;
    } else {
      // simple wrap: break by words
      const words = line.split(' ');
      let cur = '';
      for(let w of words){
        const test = cur ? (cur + ' ' + w) : w;
        if(ctx.measureText(test).width <= boxW - padding*2){
          cur = test;
        } else {
          ctx.fillText(cur, boxX + padding, ty);
          ty += lineHeight;
          cur = w;
        }
      }
      if(cur) { ctx.fillText(cur, boxX + padding, ty); ty += lineHeight; }
    }
  }

  // small watermark / brand (optional) - bottom-right corner
  const watermark = 'BÁO GIÁ';
  ctx.save();
  ctx.globalAlpha = 0.6;
  ctx.font = `${Math.round(fontSz*0.8)}px sans-serif`;
  const wmW = ctx.measureText(watermark).width;
  ctx.fillStyle = txtColor;
  ctx.fillText(watermark, canvas.width - wmW - 12, canvas.height - Math.round(fontSz*0.8) - 8);
  ctx.restore();
}

// event handlers
renderBtn.addEventListener('click', ()=>{
  drawOverlay();
});

downloadBtn.addEventListener('click', ()=>{
  if(!imgLoaded){ alert('Chưa có ảnh để tải.'); return; }
  const mime = exportFormat.value || 'image/png';
  const dataUrl = canvas.toDataURL(mime);
  const a = document.createElement('a');
  a.href = dataUrl;
  a.download = `baogia-${Date.now()}.${mime === 'image/png' ? 'png' : 'jpg'}`;
  document.body.appendChild(a);
  a.click();
  a.remove();
});

downloadJpeg.addEventListener('click', ()=>{
  if(!imgLoaded){ alert('Chưa có ảnh để tải.'); return; }
  // explicitly JPEG with quality 0.9
  const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
  const a = document.createElement('a');
  a.href = dataUrl;
  a.download = `baogia-${Date.now()}.jpg`;
  document.body.appendChild(a);
  a.click();
  a.remove();
});

// "Tạo & Tải nhanh": vẽ rồi tự download PNG
downloadImmediate.addEventListener('click', ()=>{
  if(!imgLoaded){ alert('Chưa có ảnh để xử lý.'); return; }
  drawOverlay();
  setTimeout(()=>downloadBtn.click(), 120); // tiny delay to ensure drawing done
});

// Reset
resetBtn.addEventListener('click', ()=>{
  ctx.clearRect(0,0,canvas.width,canvas.height);
  canvas.width = 800; canvas.height = 500;
  imgLoaded = false;
  imageInput.value = '';
  productName.value = '';
  sizeInput.value = '';
  qtyInput.value = 1;
  priceInput.value = '';
  phoneInput.value = '';
  // reset date to today
  (function setToday(){
    const today = new Date();
    const y = today.getFullYear();
    const m = String(today.getMonth()+1).padStart(2,'0');
    const d = String(today.getDate()).padStart(2,'0');
    quoteDate.value = `${y}-${m}-${d}`;
  })();
  // clear canvas
  ctx.fillStyle = '#fff';
  ctx.fillRect(0,0,canvas.width,canvas.height);
});

// when enter price, display formatted? we only draw formatted price - optionally preview
priceInput.addEventListener('input', ()=>{
  // nothing to do, we format on draw; could add preview near input if needed
});

// initial blank canvas size
(function initCanvas(){
  canvas.width = 1000;
  canvas.height = 600;
  ctx.fillStyle = '#fff';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = '#9ca3af';
  ctx.font = '18px sans-serif';
  ctx.fillText('Chưa có ảnh. Vui lòng chọn ảnh sản phẩm ở bên phải.', 28, 36);
})();

// OPTIONAL: support drag & drop onto canvas
['dragenter','dragover','dragleave','drop'].forEach(evt=>{
  canvas.addEventListener(evt, (e)=> e.preventDefault());
});
canvas.addEventListener('drop', (e)=>{
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  if(f && f.type.startsWith('image/')){
    const dt = new DataTransfer();
    dt.items.add(f);
    imageInput.files = dt.files;
    // trigger change
    const ev = new Event('change', {bubbles:true});
    imageInput.dispatchEvent(ev);
  }
});
</script>
</body>
</html>
