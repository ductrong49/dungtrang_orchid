<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Admin Quản Lý Hình Ảnh</title>
<style>
  body { font-family: Arial; padding: 20px; background: #f0f2f5; }
  h1 { text-align:center; color:#333; margin-bottom:25px; }
  .box {
    background:#fff; padding:20px; border-radius:10px;
    box-shadow:0 3px 10px rgba(0,0,0,0.12); margin-bottom:25px;
  }
  label { font-weight:bold; }
  select, input[type="file"], input[type="text"] {
    padding:10px; margin:8px 0; width:100%; border-radius:6px; border:1px solid #ccc;
  }
  button {
    padding:10px 20px; cursor:pointer; border:none; background:#0074D9;
    color:#fff; border-radius:6px; font-size:15px;
  }
  button:hover { background:#005fa3; }

  #images {
    display:flex; flex-wrap:wrap; gap:20px; margin-top:20px;
  }

  .img-item {
    width:200px; background:#fff; border-radius:10px;
    box-shadow:0 3px 10px rgba(0,0,0,0.15);
    overflow:hidden; text-align:center; transition:0.2s;
  }
  .img-item:hover { transform:scale(1.03); }

  .img-item img {
    width:100%; height:180px; object-fit:cover;
  }

  .img-name {
    font-size:14px; padding:6px; white-space:nowrap;
    overflow:hidden; text-overflow:ellipsis;
  }

  .delete-btn {
    width:100%; background:#FF4136 !important; padding:10px;
    border:none; color:#fff; cursor:pointer; font-weight:bold;
  }
  .delete-btn:hover { background:#d93329 !important; }

  #progress {
    margin-top:10px; font-size:14px; color:#333;
    font-weight:bold; white-space:pre-line;
  }
</style>
</head>

<body>

<h1>ADMIN QUẢN LÝ HÌNH HOA LAN</h1>

<div class="box">
  <h3>1. Nhập Token GitHub</h3>
  <input type="text" id="token" placeholder="Dán GitHub Personal Access Token tại đây">
</div>

<div class="box">
  <h3>2. Upload Hình</h3>

  <label>Chọn Album</label>
  <select id="folderSelect"></select>

  <label>Chọn Hình (nhiều file)</label>
  <input type="file" id="fileInput" multiple>

  <button onclick="uploadMultiple()">Upload</button>

  <div id="progress"></div>
</div>

<div class="box">
  <h3>3. Danh sách hình trong album</h3>
  <button onclick="loadImages()">Tải lại danh sách</button>
  <div id="images"></div>
</div>

<script>
const USERNAME = "ductrong49";
const REPO = "dungtrang_orchid";
const repoAPI = `https://api.github.com/repos/${USERNAME}/${REPO}/contents`;

const albumsMap = {
  "Mẫu Hoa": "MauHoa",
  "Mẫu Đại": "mau_dai",
  "Mẫu Trung": "mau_trung",
  "Mẫu Mini": "mau_mini"
};

function loadAlbumSelect() {
  const select = document.getElementById("folderSelect");
  select.innerHTML = "";
  for (const [name, folder] of Object.entries(albumsMap)) {
    const opt = document.createElement("option");
    opt.value = folder;
    opt.textContent = name;
    select.appendChild(opt);
  }
}
loadAlbumSelect();

/* ============================
   UPLOAD NHIỀU FILE
============================ */
async function uploadMultiple() {
  const token = document.getElementById("token").value.trim();
  if (!token) return alert("Bạn chưa nhập token!");

  const files = document.getElementById("fileInput").files;
  if (files.length === 0) return alert("Bạn chưa chọn hình!");

  const folder = document.getElementById("folderSelect").value;
  const progress = document.getElementById("progress");

  progress.textContent = `Đang upload ${files.length} hình...\n`;

  for (let i = 0; i < files.length; i++) {
    const file = files[i];

    progress.textContent += `\n▶ Upload: ${file.name}...`;

    const ok = await uploadSingle(file, folder, token);

    if (ok)
      progress.textContent += " ✔ Thành công";
    else
      progress.textContent += " ✘ Lỗi";
  }

  progress.textContent += "\n\nHoàn tất!";
  loadImages();
}

// Upload một file
async function uploadSingle(file, folder, token) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = async function () {
      const base64Content = reader.result.split(",")[1];
      const uploadURL = `${repoAPI}/${folder}/${file.name}`;

      const res = await fetch(uploadURL, {
        method: "PUT",
        headers: {
          "Authorization": `token ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: `Upload ${file.name}`,
          content: base64Content
        })
      });

      resolve(res.ok);
    };
    reader.readAsDataURL(file);
  });
}

/* ============================
   LOAD DANH SÁCH HÌNH
============================ */
async function loadImages() {
  const folder = document.getElementById("folderSelect").value;
  const imagesBox = document.getElementById("images");
  imagesBox.innerHTML = "Đang tải...";

  const res = await fetch(`${repoAPI}/${folder}`);
  const files = await res.json();

  imagesBox.innerHTML = "";

  files
    .filter(f => /\.(jpg|jpeg|png|gif|webp)$/i.test(f.name))
    .forEach(file => {
      const div = document.createElement("div");
      div.className = "img-item";

      div.innerHTML = `
        <img src="${file.download_url}">
        <div class="img-name">${file.name}</div>
        <button class="delete-btn" onclick="deleteImage('${folder}', '${file.name}')">XÓA</button>
      `;

      imagesBox.appendChild(div);
    });
}

/* ============================
   XÓA HÌNH
============================ */
async function deleteImage(folder, filename) {
  const token = document.getElementById("token").value.trim();
  if (!token) return alert("Bạn chưa nhập token!");

  const fileURL = `${repoAPI}/${folder}/${filename}`;

  const fileRes = await fetch(fileURL);
  const fileData = await fileRes.json();

  const res = await fetch(fileURL, {
    method: "DELETE",
    headers: {
      "Authorization": `token ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: `Delete ${filename}`,
      sha: fileData.sha
    })
  });

  if (res.ok) {
    alert("Đã xóa!");
    loadImages();
  } else {
    alert("Lỗi khi xóa ảnh!");
    console.log(await res.text());
  }
}

loadImages();
</script>

</body>
</html>
