<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>AI Hoa ‚Äì N·ªÅn v∆∞·ªùn blur</title>

<!-- MediaPipe -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14"></script>

<!-- ZIP -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:#f3f4f6;
  margin:0;padding:12px
}
.card{
  background:#fff;
  border-radius:16px;
  padding:14px;
  margin-bottom:80px
}
h1{font-size:18px;margin:0 0 10px}
input,button{
  width:100%;
  font-size:16px;
  margin:8px 0
}
button{
  padding:14px;
  border:none;
  border-radius:14px;
  background:#16a34a;
  color:#fff;
  font-weight:600
}
button:disabled{opacity:.5}
.footer{
  position:fixed;
  bottom:0;left:0;right:0;
  background:#fff;
  padding:10px;
  box-shadow:0 -4px 10px rgba(0,0,0,.08)
}
.progress{font-size:14px;color:#555}
</style>
</head>

<body>

<div class="card">
  <h1>üå∏ AI thay n·ªÅn hoa</h1>

  <b>·∫¢nh hoa</b>
  <input type="file" id="flowers" multiple accept="image/*">

  <b>Watermark</b>
  <input type="text" id="wm" placeholder="VD: D≈©ng Trang Orchid">

  <div class="progress" id="status">ƒêang t·∫£i AI‚Ä¶</div>
</div>

<div class="footer">
  <button id="runBtn" onclick="run()" disabled>
    X·ª¨ L√ù & T·∫¢I ZIP
  </button>
</div>

<script>
const bgList=[
 "./bg/garden1.jpg",
 "./bg/garden2.jpg",
 "./bg/garden3.jpg"
];

let segmenter;

// ‚úÖ Load AI 1 l·∫ßn
(async()=>{
  const vision = await FilesetResolver.forVisionTasks(
    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm"
  );

  segmenter = await ImageSegmenter.createFromOptions(vision,{
    baseOptions:{
      modelAssetPath:
      "https://storage.googleapis.com/mediapipe-assets/deeplabv3.tflite"
    },
    outputCategoryMask:true
  });

  status.innerText="AI s·∫µn s√†ng ‚úî";
  runBtn.disabled=false;
})();

async function run(){
  if(!flowers.files.length) return alert("Ch·ªçn ·∫£nh hoa tr∆∞·ªõc");

  runBtn.disabled=true;
  const zip=new JSZip();

  for(let i=0;i<flowers.files.length;i++){
    status.innerText=`ƒêang x·ª≠ l√Ω ${i+1}/${flowers.files.length}‚Ä¶`;

    const img=await loadImg(flowers.files[i]);
    const bg=await loadImg(bgList[Math.floor(Math.random()*bgList.length)]);
    const out=await process(img,bg,wm.value);

    zip.file(`hoa_${i+1}.png`, out.split(",")[1], {base64:true});
    await new Promise(r=>setTimeout(r,50)); // ch·ªëng ƒë∆° mobile
  }

  status.innerText="ƒê√≥ng g√≥i ZIP‚Ä¶";
  const blob=await zip.generateAsync({type:"blob"});
  saveAs(blob,"hoa_ai_blur.zip");

  status.innerText="Ho√†n t·∫•t üéâ";
  runBtn.disabled=false;
}

async function process(img,bg,wm){
  const c=document.createElement("canvas");
  c.width=img.width;
  c.height=img.height;
  const ctx=c.getContext("2d");

  // n·ªÅn blur
  ctx.filter="blur(22px)";
  ctx.drawImage(bg,0,0,c.width,c.height);
  ctx.filter="none";

  const res=segmenter.segment(img);
  const mask=res.categoryMask.getAsUint8Array();

  const srcC=document.createElement("canvas");
  srcC.width=c.width; srcC.height=c.height;
  const sctx=srcC.getContext("2d");
  sctx.drawImage(img,0,0);
  const src=sctx.getImageData(0,0,c.width,c.height).data;
  const out=ctx.getImageData(0,0,c.width,c.height);

  for(let i=0;i<mask.length;i++){
    if(mask[i]){
      out.data[i*4]=src[i*4];
      out.data[i*4+1]=src[i*4+1];
      out.data[i*4+2]=src[i*4+2];
      out.data[i*4+3]=255;
    }else out.data[i*4+3]=0;
  }

  ctx.putImageData(out,0,0);

  // watermark
  if(wm){
    ctx.font="bold 32px sans-serif";
    ctx.fillStyle="rgba(255,255,255,.75)";
    ctx.fillText(wm,20,c.height-30);
  }

  return c.toDataURL("image/png");
}

function loadImg(src){
  return new Promise(r=>{
    const i=new Image();
    i.crossOrigin="anonymous";
    i.onload=()=>r(i);
    i.src=typeof src==="string"?src:URL.createObjectURL(src);
  });
}
</script>

</body>
</html>
