<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Admin Quản Lý Hình Ảnh</title>
<style>
  body { font-family: Arial; padding: 20px; background: #f7f7f7; }
  h1 { text-align:center; color:#333; margin-bottom:25px; }
  .box { background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:25px; }
  label { font-weight:bold; }
  select, input[type="file"], input[type="text"] { padding:10px; margin:8px 0; width:100%; }
  button { padding:10px 20px; cursor:pointer; border:none; background:#0074D9; color:#fff; border-radius:6px; }
  button:hover { background:#005fa3; }
  .img-box { display:flex; flex-wrap:wrap; gap:15px; margin-top:20px; }
  .img-item { width:180px; background:#fff; border-radius:8px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,0.15); text-align:center; padding-bottom:10px; }
  .img-item img { width:100%; }
  .delete-btn { width:100%; background:#FF4136 !important; margin-top:5px; }

  #progressWrap, #deleteProgressWrap {
    width:100%; background:#ddd; height:18px; border-radius:10px; margin-top:10px; display:none;
  }
  #progressBar { height:100%; width:0%; background:#28a745; border-radius:10px; transition:0.3s; }
  #deleteProgressBar { height:100%; width:0%; background:#ff5c33; border-radius:10px; transition:0.3s; }
  #progressText, #deleteProgressText { margin-top:5px; font-size:14px; font-weight:bold; display:none; }
</style>
</head>
<body>

<h1>ADMIN QUẢN LÝ HÌNH HOA LAN</h1>

<div class="box">
  <h3>1. Nhập Token GitHub</h3>
  <input type="text" id="token" placeholder="Dán GitHub Personal Access Token tại đây">
</div>

<div class="box">
  <h3>2. Upload Hình</h3>
  <label>Chọn Album</label>
  <select id="folderSelect"></select>
  <label>Chọn Nhiều Hình</label>
  <input type="file" id="fileInput" multiple>
  <button onclick="uploadMultiple()">Upload</button>

  <div id="progressWrap">
    <div id="progressBar"></div>
  </div>
  <div id="progressText">0%</div>
</div>

<div class="box">
  <h3>3. Danh sách hình trong album</h3>
  <label>Chọn Album</label>
  <select id="viewFolderSelect"></select>
  <button onclick="loadImages()">Tải lại danh sách</button>
  <button style="background:#FF4136; margin-top:10px;" onclick="deleteSelectedImages()">XÓA CÁC HÌNH ĐÃ CHỌN</button>

  <div id="deleteProgressWrap">
    <div id="deleteProgressBar"></div>
  </div>
  <div id="deleteProgressText">0%</div>

  <div id="images" class="img-box"></div>
</div>

<script>
const USERNAME = "ductrong49";
const REPO = "dungtrang_orchid";
const repoAPI = `https://api.github.com/repos/${USERNAME}/${REPO}/contents`;

const albumsMap = {
  "Mẫu Hoa": "MauHoa",
  "Mẫu Đại": "mau_dai",
  "Mẫu Trung": "mau_trung",
  "Mẫu Mini": "mau_mini"
};

function loadAlbumSelect() {
  const upSel = document.getElementById("folderSelect");
  const viewSel = document.getElementById("viewFolderSelect");
  upSel.innerHTML = "";
  viewSel.innerHTML = "";
  for (const [name, folder] of Object.entries(albumsMap)) {
    upSel.innerHTML += `<option value="${folder}">${name}</option>`;
    viewSel.innerHTML += `<option value="${folder}">${name}</option>`;
  }
}
loadAlbumSelect();

/* -------------------------
   UPLOAD NHIỀU HÌNH SONG SONG
------------------------- */
async function uploadMultiple() {
  const token = document.getElementById("token").value.trim();
  if (!token) return alert("Bạn chưa nhập token!");
  const files = document.getElementById("fileInput").files;
  if (files.length === 0) return alert("Bạn chưa chọn hình!");
  const folder = document.getElementById("folderSelect").value;

  const progressWrap = document.getElementById("progressWrap");
  const progressBar = document.getElementById("progressBar");
  const progressText = document.getElementById("progressText");
  progressWrap.style.display = "block";
  progressText.style.display = "block";

  let done = 0;
  const concurrency = 3; // upload cùng lúc 3 file
  const chunks = [];

  for (let i=0; i<files.length; i+=concurrency) {
    chunks.push(files.slice(i, i+concurrency));
  }

  for (let chunk of chunks) {
    await Promise.all([...chunk].map(f => uploadSingleImage(f, folder, token).then(()=> {
      done++;
      let percent = Math.round((done / files.length)*100);
      progressBar.style.width = percent + "%";
      progressText.innerText = percent + "%";
    })));
  }

  setTimeout(()=>{progressWrap.style.display="none"; progressText.style.display="none"; progressBar.style.width="0%";},1000);
  alert(`Upload xong ${done} hình!`);
  loadImages();
}

async function uploadSingleImage(file, folder, token) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = async function() {
      const base64Content = reader.result.split(",")[1];
      await fetch(`${repoAPI}/${folder}/${file.name}`, {
        method:"PUT",
        headers:{ "Authorization":`token ${token}`, "Content-Type":"application/json" },
        body: JSON.stringify({ message:`Upload ${file.name}`, content:base64Content })
      });
      resolve();
    };
    reader.readAsDataURL(file);
  });
}

/* -------------------------
   LOAD HÌNH
------------------------- */
async function loadImages() {
  const folder = document.getElementById("viewFolderSelect").value;
  const imagesBox = document.getElementById("images");
  imagesBox.innerHTML = "Đang tải...";
  const res = await fetch(`${repoAPI}/${folder}`);
  const files = await res.json();
  imagesBox.innerHTML = "";
  files.filter(f => /\.(jpg|jpeg|png|gif|webp)$/i.test(f.name))
    .forEach(file => {
      imagesBox.innerHTML += `
        <div class="img-item">
          <input type="checkbox" class="img-check" data-name="${file.name}" style="margin-top:8px;">
          <img src="${file.download_url}">
          <button class="delete-btn" onclick="deleteImage('${folder}', '${file.name}')">XÓA</button>
        </div>`;
    });
}

/* -------------------------
   XÓA 1 HÌNH CÓ CONFIRM
------------------------- */
async function deleteImage(folder, filename){
  const token=document.getElementById("token").value.trim();
  if(!token) return alert("Bạn chưa nhập token!");
  if(!confirm(`Bạn có chắc muốn xóa hình: ${filename}?`)) return;
  await deleteFileAPI(folder, filename, token);
  loadImages();
}

/* -------------------------
   XÓA FILE API
------------------------- */
async function deleteFileAPI(folder, filename, token){
  const fileURL=`${repoAPI}/${folder}/${filename}`;
  const fileRes=await fetch(fileURL);
  const fileData=await fileRes.json();
  return fetch(fileURL,{
    method:"DELETE",
    headers:{ "Authorization":`token ${token}`,"Content-Type":"application/json" },
    body:JSON.stringify({ message:`Delete ${filename}`, sha:fileData.sha })
  });
}

/* -------------------------
   XÓA NHIỀU HÌNH SONG SONG
------------------------- */
async function deleteSelectedImages(){
  const token=document.getElementById("token").value.trim();
  if(!token) return alert("Bạn chưa nhập token!");
  const folder=document.getElementById("viewFolderSelect").value;
  const checks=document.querySelectorAll(".img-check:checked");
  if(checks.length===0) return alert("Bạn chưa chọn hình!");

  const total=checks.length;
  const wrap=document.getElementById("deleteProgressWrap");
  const bar=document.getElementById("deleteProgressBar");
  const text=document.getElementById("deleteProgressText");

  wrap.style.display="block";
  text.style.display="block";
  bar.style.width="0%";
  text.innerText="0%";

  let done=0;
  const concurrency=3; // xóa cùng lúc 3 file
  const arrChecks=[...checks];

  for(let i=0;i<arrChecks.length;i+=concurrency){
    const chunk=arrChecks.slice(i,i+concurrency);
    await Promise.all(chunk.map(c => deleteFileAPI(folder,c.dataset.name,token).then(()=>{
      done++;
      let percent=Math.round((done/total)*100);
      bar.style.width=percent+"%";
      text.innerText=percent+"%";
    })));
  }

  setTimeout(()=>{wrap.style.display="none"; text.style.display="none"; bar.style.width="0%";},700);
  alert(`Đã xóa ${done} hình!`);
  loadImages();
}

loadImages();
</script>
</body>
</html>
